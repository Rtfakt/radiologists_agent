# СПЕЦИФИКАЦИЯ ПРИЛОЖЕНИЯ
## "Конструктор рентгеновских заключений"

---

## 1. ОБЩЕЕ ОПИСАНИЕ

### 1.1. Назначение приложения
Приложение представляет собой инструмент для автоматизированного формирования рентгеновских заключений с поддержкой различных модальностей через систему плагинов. Приложение позволяет врачам-рентгенологам быстро создавать стандартизированные заключения на основе введенных параметров исследования.

### 1.2. Целевая аудитория
- Врачи-рентгенологи

### 1.3. Основные возможности
- Динамическая загрузка плагинов для различных модальностей
- Автоматическое формирование текстов заключений на основе введенных параметров
- Значительное ускорение и автоматизация рутинной части работы рентгенолога при формировании шаблонных описаний
- Редактирование сформированных текстов
- Поддержка шаблонов для стандартизации формулировок
- Модульная архитектура для легкого расширения функциональности

---

## 2. АРХИТЕКТУРА ПРИЛОЖЕНИЯ

### 2.1. Общая архитектура
Приложение построено на принципах **Clean Architecture** с разделением на слои:

```
┌─────────────────────────────────────────┐
│           UI Layer (PySide6)            │
│         (ui/main_window.py)             │
└─────────────────┬───────────────────────┘
                  │
┌─────────────────▼───────────────────────┐
│        Domain Layer                     │
│  (entities, services, ports)            │
└─────────────────┬───────────────────────┘
                  │
┌─────────────────▼───────────────────────┐
│      Adapters Layer                     │
│  (storage, ui implementations)          │
└─────────────────┬───────────────────────┘
                  │
┌─────────────────▼───────────────────────┐
│      Plugins Layer                      │
│  (mammography, densitometry, ...)       │
└─────────────────────────────────────────┘
```

### 2.2. Структура проекта

```
radiologists_agent/
├── core/                          # Ядро приложения (без UI зависимостей)
│   ├── __init__.py
│   └── plugin_base.py            # Базовые классы для плагинов
│
├── domain/                        # Доменный слой (бизнес-логика)
│   ├── __init__.py
│   ├── entities.py               # Доменные сущности (Report, Template, Modality)
│   └── services.py               # Бизнес-сервисы (ReportService)
│
├── ports/                         # Порты (интерфейсы)
│   ├── __init__.py
│   ├── ui_port.py                # Интерфейс UI адаптера
│   └── storage_port.py           # Интерфейс хранилища данных
│
├── adapters/                      # Адаптеры (реализации портов)
│   ├── __init__.py
│   ├── storage/
│   │   ├── __init__.py
│   │   └── in_memory_storage.py  # In-memory реализация хранилища
│   └── ui/
│       ├── __init__.py
│       └── tkinter_ui.py          # Tkinter реализация UI (не используется)
│
├── plugins/                       # Плагины модальностей
│   ├── __init__.py
│   ├── mammography/              # Плагин маммографии
│   │   ├── __init__.py
│   │   └── plugin.py
│   └── densitometry/             # Плагин денситометрии
│       ├── __init__.py
│       └── plugin.py
│
├── ui/                            # UI слой (PySide6)
│   ├── __init__.py
│   └── main_window.py            # Главное окно приложения
│
├── main.py                        # Точка входа в приложение
├── requirements.txt              # Зависимости проекта
└── README.md                      # Документация проекта
```

### 2.3. Технологический стек
- **Язык программирования**: Python 3.11+
- **GUI Framework**: PySide6 (Qt для Python)
- **Архитектурный паттерн**: Clean Architecture, Plugin Pattern
- **Парадигма**: Объектно-ориентированное программирование

---

## 3. ДОМЕННАЯ МОДЕЛЬ

### 3.1. Сущности (Entities)

#### 3.1.1. Modality (Enum)
Тип модальности исследования.

**Значения:**
- `XRAY` - Рентгенография
- `MAMMOGRAPHY` - Маммография
- `DENSITOMETRY` - Денситометрия

#### 3.1.2. Report
Сущность рентгеновского заключения.

**Поля:**
- `id: str` - Уникальный идентификатор заключения
- `modality: Modality` - Тип модальности
- `original_text: str` - Исходный текст заключения
- `processed_text: Optional[str]` - Обработанный текст (после применения шаблона)
- `template_name: Optional[str]` - Имя примененного шаблона

#### 3.1.3. Template
Шаблон для замены текста в заключениях.

**Поля:**
- `name: str` - Название шаблона
- `modality: Modality` - Модальность, для которой предназначен шаблон
- `replacements: Dict[str, str]` - Словарь замен: исходный текст → целевой текст

### 3.2. Сервисы (Services)

#### 3.2.1. ReportService
Сервис для работы с рентгеновскими заключениями.

**Методы:**
- `set_template(template: Template)` - Установить шаблон для замены
- `process_report(report: Report) -> Report` - Обработать заключение по шаблону
- `create_report(report_id: str, modality: Modality, original_text: str) -> Report` - Создать новое заключение

**Логика обработки:**
1. Если шаблон не установлен, возвращает исходный текст
2. Применяет все замены из словаря `replacements` к исходному тексту
3. Сохраняет имя примененного шаблона в отчете

---

## 4. СИСТЕМА ПЛАГИНОВ

### 4.1. Базовые классы

#### 4.1.1. BasePlugin (ABC)
Базовый абстрактный класс для всех плагинов.

**Методы:**
- `get_name() -> str` - Возвращает название плагина
- `get_description() -> str` - Возвращает описание плагина

#### 4.1.2. ModalityPlugin (BasePlugin)
Базовый класс для плагинов модальностей.

**Методы:**
- `get_name() -> str` - Название модальности
- `get_description() -> str` - Описание модальности
- `create_widget() -> QWidget` - Создает виджет для работы с модальностью
- `get_generated_text() -> str` - Возвращает сформированный текст (опционально)

### 4.2. Механизм загрузки плагинов

**Процесс загрузки:**
1. При запуске приложения сканируется директория `plugins/`
2. Для каждой поддиректории ищется файл `plugin.py`
3. Файл динамически импортируется через `importlib`
4. Из модуля извлекается класс `Plugin`
5. Проверяется, что класс наследуется от `ModalityPlugin`
6. Создается экземпляр плагина и добавляется в список доступных

**Требования к плагину:**
- Должен находиться в поддиректории `plugins/<plugin_name>/`
- Должен содержать файл `plugin.py`
- Должен экспортировать класс `Plugin`, наследующийся от `ModalityPlugin`

### 4.3. Реализованные плагины

#### 4.3.1. Плагин маммографии (MammographyPlugin)

**Функциональность:**
- Выбор плотности молочной железы по классификации ACR (A, B, C, D)
- Выбор типа заключения (Норма, ФЖИ, ФКМ)
- Автоматическая замена текста плотности в шаблоне
- Автоматическая замена текста заключения
- Редактирование итогового текста

**UI компоненты:**
- Левая колонка: текстовое поле для редактирования заключения, кнопка "Сформировать отчет"
- Правая колонка: кнопки выбора плотности (A, B, C, D), кнопки выбора заключения (Норма, ФЖИ, ФКМ)

**Логика работы:**
1. Пользователь выбирает плотность и заключение
2. Нажимает кнопку "Сформировать отчет"
3. Система находит в тексте паттерны плотности и заключения
4. Заменяет их на соответствующие тексты из словарей
5. Обновляет текстовое поле

#### 4.3.2. Плагин денситометрии (DensitometryPlugin)

**Базовое описание:**
Плагин для генерации медицинских отчетов по денситометрии. Интерфейс разделен на две секции:
- **Левая часть**: текстовые редакторы для отображения сгенерированных отчетов
- **Правая часть**: поля ввода числовых параметров с кнопками генерации

**Форматы полей ввода:**

*T/Z-поля (T-критерий, Z-критерий):*
- Диапазон: -5.0 до 5.0
- Шаг: 0.1
- Формат отображения: 2 знака после запятой (для отображения в UI)
- Формат в отчете: 1 знак после запятой
- Примеры: -1.5, 0.2, -2.0

*BMD поля (Костная масса):*
- Диапазон: 0.0 до 2.0
- Шаг: 0.01
- Формат отображения: 3 знака после запятой
- Примеры: 0.835, 1.120

*FRAX поле:*
- Диапазон: 0.0 до 100.0
- Шаг: 0.1
- Формат отображения: 1 знак после запятой
- Доступно только для шейки бедренной кости

**UI компоненты:**
- **Левая колонка**: 
  - Текстовое поле "Текст заключения - Позвоночник"
  - Текстовое поле "Текст заключения - Бедренная кость"
  - Кнопка "Сформировать целиком"
- **Правая колонка**: 
  - Группа "Позвоночник (L1-L4)": T-критерий, Z-критерий, костная масса (г/см²), кнопка "Сформировать"
  - Группа "Шейка бедренной кости (femoral neck)": T-критерий, Z-критерий, костная масса (г/см²), FRAX (%), кнопка "Сформировать"
  - Группа "Проксимальный отдел бедра в целом (total hip)": T-критерий, Z-критерий, костная масса (г/см²)

**Правила валидации:**

*Для позвоночника:*
- **Условие**: `spine_bmd ≠ 0` И (`spine_t_score ≠ 0` ИЛИ `spine_z_score ≠ 0`)
- **Ошибка**: "Для позвоночника заполните костную массу и хотя бы один критерий (T или Z)"

*Для бедренной кости (две проверки):*
- **Условие 1 (шейка бедренной кости)**: `femur_bmd ≠ 0` И (`femur_t_score ≠ 0` ИЛИ `femur_z_score ≠ 0`) И `femur_frax ≠ 0`
- **Ошибка 1**: "Для шейки бедренной кости заполните костную массу, хотя бы один критерий (T или Z) и FRAX"
- **Условие 2 (total hip)**: `total_hip_bmd ≠ 0` И (`total_hip_t_score ≠ 0` ИЛИ `total_hip_z_score ≠ 0`)
- **Ошибка 2**: "Для проксимального отдела бедра (total hip) заполните костную массу и хотя бы один критерий (T или Z)"

*Порядок проверок:*
1. Кнопка "Сформировать" (позвоночник) → проверка позвоночника
2. Кнопка "Сформировать" (бедренная кость) → проверка Условия 1, затем Условия 2
3. Кнопка "Сформировать целиком" → проверка позвоночника, затем бедренной кости

**Важно**: При любой ошибке генерация отчета не выполняется, показывается только первая обнаруженная ошибка.

**Механизм отображения ошибок:**
- **Место**: Tooltip (всплывающая подсказка) у нажатой кнопки
- **Поведение**: Tooltip появляется при наведении после неудачной валидации
- **Автоматическое скрытие**: Не требуется, скрывается при уходе курсора

**Механизм копирования в буфер обмена (системный):**

*Для позвоночника:*
1. Нажатие "Сформировать" (успешная валидация) → копируется описание позвоночника в системный буфер
2. Пользователь нажимает Ctrl+V в другом приложении → вставляется описание
3. Автоматически содержимое буфера заменяется на заключение позвоночника
4. Пользователь снова нажимает Ctrl+V → вставляется заключение
5. После второго Ctrl+V буфер очищается

*Для бедренной кости:*
- Аналогично, но с текстом бедренной кости

*Для "Сформировать целиком":*
1. Копируется описание (позвоночник + бедро)
2. После первого Ctrl+V → заменяется на заключение (позвоночник + бедро)
3. После второго Ctrl+V → буфер очищается

**Алгоритм отслеживания вставки:**
1. После копирования в буфер запускается мониторинг буфера обмена
2. При обнаружении, что содержимое буфера изменилось (пользователь вставил текст) → заменяем содержимое на следующую часть
3. После второго изменения → очищаем буфер

**Конфликтующие операции:**
- Если пользователь нажимает "Сформировать целиком" до завершения предыдущей операции копирования → прерывается предыдущая операция, начинает новую (описание всего отчета)

**Форматирование вывода в отчете:**
- T/Z-критерии: 1 знак после запятой
- BMD: 3 знака после запятой
- FRAX: 1 знак после запятой

**Диагностическая логика:**
- `t_score ≤ -2.5` → "Остеопороз"
- `-2.5 < t_score ≤ -2.0` → "Остеопения 3 ст."
- `-2.0 < t_score ≤ -1.5` → "Остеопения 2 ст"
- `-1.5 < t_score ≤ -1.1` → "Остеопения 1 ст"
- `t_score > -1.1` → "Норма"

**Технические детали реализации:**
- **Мониторинг буфера**: Использовать `QClipboard.dataChanged()` сигнал для отслеживания изменений
- **Состояния копирования**: Хранить текущее состояние (ожидает_вставки_1, ожидает_вставки_2, завершено)
- **Очистка буфера**: После второй вставки устанавливать пустую строку
- **Отмена операций**: При начале новой операции копирования сбрасывать состояние предыдущей

---

## 5. ПОЛЬЗОВАТЕЛЬСКИЙ ИНТЕРФЕЙС

### 5.1. Главное окно (MainWindow)

**Структура:**
```
┌─────────────────────────────────────────────────────┐
│  Конструктор рентгеновских заключений              │
├─────────────────────────────────────────────────────┤
│  Модальности: [Маммография] [Денситометрия]       │
├─────────────────────────────────────────────────────┤
│                                                     │
│  [Виджет выбранного плагина]                       │
│                                                     │
└─────────────────────────────────────────────────────┘
```

**Компоненты:**
- **Верхняя панель**: Горизонтальный список кнопок для выбора модальности
- **Основная область**: Скроллируемая область с виджетом выбранного плагина
- **Заголовок**: Отображает название выбранной модальности

**Поведение:**
- При клике на кнопку модальности загружается соответствующий виджет плагина
- Выбранная кнопка подсвечивается зеленым цветом
- Предыдущий виджет удаляется при переключении

### 5.2. Общие требования к UI
- Минимальный размер окна: 1200x800 пикселей
- Адаптивная компоновка с использованием QHBoxLayout и QVBoxLayout
- Поддержка скроллинга для длинных виджетов
- Визуальная обратная связь при выборе модальности

---

## 6. ХРАНИЛИЩЕ ДАННЫХ

### 6.1. Интерфейс StorageAdapter

**Методы:**
- `save_report(report: Report) -> None` - Сохранить заключение
- `get_report(report_id: str) -> Optional[Report]` - Получить заключение по ID
- `get_all_reports() -> List[Report]` - Получить все заключения
- `save_template(template: Template) -> None` - Сохранить шаблон
- `get_template(template_name: str) -> Optional[Template]` - Получить шаблон по имени
- `get_all_templates() -> List[Template]` - Получить все шаблоны
- `get_templates_by_modality(modality: Modality) -> List[Template]` - Получить шаблоны для модальности

### 6.2. Реализация InMemoryStorage

**Особенности:**
- Хранение данных в памяти (словари Python)
- Данные теряются при закрытии приложения
- Инициализация предустановленных шаблонов при создании

**Предустановленные шаблоны:**
- **XRAY**: "Стандартный", "Формализованный"
- **MAMMOGRAPHY**: "Mammo: стандарт"
- **DENSITOMETRY**: "DXA: стандарт"

---

## 7. ФУНКЦИОНАЛЬНЫЕ ТРЕБОВАНИЯ

### 7.1. Основной функционал

**FR-1: Загрузка плагинов**
- Приложение должно автоматически обнаруживать и загружать все плагины из директории `plugins/`
- При ошибке загрузки одного плагина остальные должны продолжать работать
- В консоль должны выводиться сообщения об успешной/неуспешной загрузке

**FR-2: Выбор модальности**
- Пользователь должен иметь возможность выбрать модальность из списка доступных
- При выборе модальности должен отображаться соответствующий виджет плагина
- Выбранная модальность должна визуально выделяться

**FR-3: Формирование заключений**
- Каждый плагин должен предоставлять интерфейс для ввода параметров исследования
- Приложение должно формировать текст заключения на основе введенных параметров
- Пользователь должен иметь возможность редактировать сформированный текст

**FR-4: Работа с шаблонами**
- Система должна поддерживать применение шаблонов для замены текста
- Шаблоны должны быть привязаны к конкретным модальностям
- Должна быть возможность получения списка шаблонов для модальности

### 7.2. Функционал плагина маммографии

**FR-5: Выбор плотности**
- Пользователь должен иметь возможность выбрать плотность A, B, C или D
- Выбранная плотность должна визуально выделяться
- При формировании отчета текст плотности должен заменяться в шаблоне

**FR-6: Выбор заключения**
- Пользователь должен иметь возможность выбрать тип заключения (Норма, ФЖИ, ФКМ)
- Выбранное заключение должно визуально выделяться
- При формировании отчета текст заключения должен заменяться в шаблоне

**FR-7: Формирование текста маммографии**
- Система должна находить и заменять паттерны плотности в тексте
- Система должна находить и заменять паттерны заключения в тексте
- Замена должна происходить для обеих молочных желез (правая и левая)

### 7.3. Функционал плагина денситометрии

**FR-8: Ввод параметров позвоночника**
- Пользователь должен иметь возможность ввести T-критерий (-5.0 до 5.0, шаг 0.1, формат: 2 знака после запятой в UI)
- Пользователь должен иметь возможность ввести Z-критерий (-5.0 до 5.0, шаг 0.1, формат: 2 знака после запятой в UI)
- Пользователь должен иметь возможность ввести костную массу (0.0 до 2.0, шаг 0.01, формат: 3 знака после запятой)

**FR-9: Ввод параметров бедренной кости**
- Пользователь должен иметь возможность ввести параметры для шейки бедренной кости (T, Z, BMD, FRAX)
- Пользователь должен иметь возможность ввести параметры для проксимального отдела бедра (T, Z, BMD)
- FRAX должен быть доступен только для шейки бедренной кости (0.0 до 100.0, шаг 0.1, формат: 1 знак после запятой)

**FR-10: Валидация входных данных**
- При нажатии кнопки "Сформировать" для позвоночника система должна проверять: `spine_bmd ≠ 0` И (`spine_t_score ≠ 0` ИЛИ `spine_z_score ≠ 0`)
- При нажатии кнопки "Сформировать" для бедренной кости система должна проверять:
  - Для шейки: `femur_bmd ≠ 0` И (`femur_t_score ≠ 0` ИЛИ `femur_z_score ≠ 0`) И `femur_frax ≠ 0`
  - Для total hip: `total_hip_bmd ≠ 0` И (`total_hip_t_score ≠ 0` ИЛИ `total_hip_z_score ≠ 0`)
- При нажатии "Сформировать целиком" должны проверяться все условия последовательно
- При ошибке валидации генерация отчета не выполняется, показывается только первая обнаруженная ошибка в tooltip кнопки

**FR-11: Определение диагноза**
- Система должна автоматически определять диагноз на основе T-критерия
- Диагноз должен соответствовать классификации ВОЗ:
  - `t_score ≤ -2.5` → "Остеопороз"
  - `-2.5 < t_score ≤ -2.0` → "Остеопения 3 ст."
  - `-2.0 < t_score ≤ -1.5` → "Остеопения 2 ст"
  - `-1.5 < t_score ≤ -1.1` → "Остеопения 1 ст"
  - `t_score > -1.1` → "Норма"

**FR-12: Формирование текста денситометрии**
- Система должна формировать текст для позвоночника с подстановкой всех параметров
- Система должна формировать текст для бедренной кости с подстановкой всех параметров
- Должна быть возможность формировать отчеты отдельно или целиком
- Форматирование в отчете:
  - T/Z-критерии: 1 знак после запятой
  - BMD: 3 знака после запятой
  - FRAX: 1 знак после запятой

**FR-13: Копирование в системный буфер обмена**
- При успешной валидации и нажатии "Сформировать" (позвоночник) текст описания позвоночника должен копироваться в системный буфер обмена
- При успешной валидации и нажатии "Сформировать" (бедренная кость) текст описания бедренной кости должен копироваться в системный буфер обмена
- При нажатии "Сформировать целиком" должен копироваться текст описания (позвоночник + бедро)
- Система должна отслеживать изменения буфера обмена через `QClipboard.dataChanged()`
- После первой вставки (Ctrl+V) содержимое буфера должно автоматически заменяться на заключение
- После второй вставки буфер должен очищаться
- При начале новой операции копирования предыдущая операция должна прерываться

---

## 8. НЕФУНКЦИОНАЛЬНЫЕ ТРЕБОВАНИЯ

### 8.1. Производительность
- Загрузка приложения должна занимать не более 3 секунд
- Переключение между плагинами должно происходить мгновенно
- Формирование текста заключения должно происходить без задержек

### 8.2. Надежность
- Приложение не должно падать при ошибках в плагинах
- Ошибки загрузки плагинов должны логироваться, но не прерывать работу приложения
- Некорректные данные в полях ввода должны обрабатываться gracefully

### 8.3. Расширяемость
- Добавление нового плагина не должно требовать изменения основного кода
- Плагины должны быть изолированы друг от друга
- Архитектура должна поддерживать добавление новых модальностей

### 8.4. Удобство использования
- Интерфейс должен быть интуитивно понятным
- Все поля должны иметь понятные названия
- Кнопки должны иметь четкие названия, отражающие их функцию

### 8.5. Совместимость
- Приложение должно работать на Windows, macOS и Linux
- Требуется Python 3.11 или выше
- PySide6 версии 6.0.0 или выше

---

## 9. ВОПРОСЫ ДЛЯ УТОЧНЕНИЯ

### 9.1. Функциональность
1. **Сохранение отчетов**: Нужна ли возможность сохранять сформированные отчеты? В каком формате (текст, PDF, DOCX)?
2. **Экспорт данных**: Требуется ли экспорт отчетов во внешние системы (МИС, PACS)?
3. **История изменений**: Нужна ли возможность отслеживать историю изменений отчетов?
4. **Печать**: Требуется ли функция печати отчетов?

### 9.2. Управление шаблонами
1. **Создание шаблонов**: Должны ли пользователи иметь возможность создавать собственные шаблоны?
2. **Редактирование шаблонов**: Нужна ли возможность редактирования существующих шаблонов?
3. **Импорт/экспорт шаблонов**: Требуется ли возможность обмена шаблонами между пользователями?

### 9.3. Безопасность и доступ
1. **Авторизация**: Нужна ли система авторизации пользователей?
2. **Разграничение прав**: Требуется ли разграничение прав доступа?
3. **Логирование**: Нужно ли логирование действий пользователей?

### 9.4. Хранение данных
1. **Постоянное хранилище**: Нужна ли замена in-memory хранилища на файловое или БД?
2. **Резервное копирование**: Требуется ли автоматическое резервное копирование данных?
3. **Синхронизация**: Нужна ли синхронизация данных между несколькими установками?

### 9.5. Интеграции
1. **МИС**: Требуется ли интеграция с медицинскими информационными системами?
2. **PACS**: Нужна ли интеграция с системами архивации изображений?
3. **DICOM**: Требуется ли поддержка стандарта DICOM?

### 9.6. Масштабирование
1. **Количество пользователей**: Сколько пользователей будет работать с приложением одновременно?
2. **Количество плагинов**: Сколько плагинов планируется добавить в будущем?
3. **Объем данных**: Какой объем отчетов планируется обрабатывать?

### 9.7. Интернационализация
1. **Многоязычность**: Требуется ли поддержка других языков кроме русского?
2. **Локализация**: Нужна ли адаптация интерфейса для разных регионов?

---

## 10. ПЛАН РАЗВИТИЯ (ПРЕДПОЛАГАЕМЫЙ)

### 10.1. Краткосрочные задачи
- [ ] Добавление функционала сохранения отчетов (включая экспорт в `.docx`)
- [ ] Реализация файлового хранилища
- [ ] Улучшение обработки ошибок
- [ ] Добавление валидации входных данных

### 10.2. Среднесрочные задачи
- [ ] Создание системы управления шаблонами через UI (создание/редактирование пользовательских шаблонов)
- [ ] Добавление экспорта отчетов в дополнительные форматы (PDF, текстовые файлы и др.)
- [ ] Реализация истории изменений
- [ ] Добавление функции поиска по отчетам

### 10.3. Долгосрочные задачи
- [ ] Интеграция с МИС
- [ ] Поддержка DICOM
- [ ] Система авторизации и разграничения прав
- [ ] Веб-версия приложения

---

## 11. ТЕХНИЧЕСКАЯ ДОКУМЕНТАЦИЯ

### 11.1. Зависимости
```
PySide6>=6.0.0
```

### 11.2. Установка и запуск
```bash
# Установка зависимостей
pip install -r requirements.txt

# Запуск приложения
python main.py
```

### 11.3. Разработка плагинов
См. раздел 4.2 и примеры в `plugins/mammography/plugin.py` и `plugins/densitometry/plugin.py`

### 11.4. Реализация механизма копирования в буфер обмена (плагин денситометрии)

**Технические детали:**
- Использовать `QClipboard` из `PySide6.QtGui` для работы с системным буфером обмена
- Подписаться на сигнал `QClipboard.dataChanged()` для отслеживания изменений буфера
- Реализовать состояние машины для отслеживания этапов копирования:
  - `IDLE` - нет активной операции
  - `WAITING_FIRST_PASTE` - ожидается первая вставка (описание в буфере)
  - `WAITING_SECOND_PASTE` - ожидается вторая вставка (заключение в буфере)
  - `COMPLETED` - операция завершена, буфер очищен

**Алгоритм работы:**
1. При успешной валидации и нажатии кнопки формирования:
   - Копировать описание в буфер через `QClipboard.setText()`
   - Установить состояние `WAITING_FIRST_PASTE`
   - Подписаться на `dataChanged()` (если еще не подписаны)
2. При срабатывании `dataChanged()`:
   - Проверить текущее состояние
   - Если `WAITING_FIRST_PASTE`: заменить содержимое буфера на заключение, установить `WAITING_SECOND_PASTE`
   - Если `WAITING_SECOND_PASTE`: очистить буфер (`setText("")`), установить `COMPLETED` или `IDLE`
3. При начале новой операции:
   - Отменить предыдущую операцию (сбросить состояние в `IDLE`)
   - Начать новую операцию

**Важные моменты:**
- Избегать рекурсивных вызовов при обработке `dataChanged()` (проверять, что изменение инициировано не самим приложением)
- Очищать подписки при закрытии виджета плагина
- Обрабатывать случаи, когда пользователь копирует что-то другое во время операции

---

## 12. ГЛОССАРИЙ

- **Модальность** - Тип медицинского исследования (рентген, маммография, денситометрия и т.д.)
- **Плагин** - Модуль, расширяющий функциональность приложения для конкретной модальности
- **Шаблон** - Набор правил замены текста для стандартизации формулировок
- **T-критерий** - Стандартизированный показатель в денситометрии, сравнивающий плотность кости пациента с пиковой костной массой здорового взрослого
- **Z-критерий** - Стандартизированный показатель в денситометрии, сравнивающий плотность кости пациента со средним значением для его возраста
- **BMD (Bone Mineral Density)** - Показатель минеральной плотности кости
- **FRAX** - Инструмент оценки риска переломов (Fracture Risk Assessment Tool)
- **ACR** - Классификация плотности молочной железы по системе American College of Radiology
- **BIRADS** - Система оценки и отчетности по визуализации молочной железы (Breast Imaging Reporting and Data System)

---

**Дата создания документа**: 26 января 2026  
**Версия документа**: 1.1  
**Статус**: Актуальная версия (спецификация плагина денситометрии детализирована)
